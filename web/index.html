<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passkey Demo - æ— å¯†ç ç™»å½•æ¼”ç¤º</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 600;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .demo-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        .demo-info h3 {
            margin-top: 0;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Passkey Demo</h1>
        
        <div class="demo-info">
            <h3>ğŸ“± æ¼”ç¤ºè¯´æ˜</h3>
            <p>è¿™æ˜¯ä¸€ä¸ª Passkey æ— å¯†ç ç™»å½•æ¼”ç¤ºç³»ç»Ÿã€‚æ”¯æŒåœ¨ iOS Safari ä¸­ä½¿ç”¨ Face ID/Touch ID è¿›è¡Œå®‰å…¨ç™»å½•ã€‚</p>
            <p><strong>æ³¨æ„ï¼š</strong>è¯·åœ¨ iOS Safari æˆ–æ”¯æŒ WebAuthn çš„ç°ä»£æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é¡µé¢ã€‚</p>
        </div>

        <div class="form-group">
            <label for="username">ç”¨æˆ·åï¼š</label>
            <input type="text" id="username" value="demo_user" placeholder="è¾“å…¥ç”¨æˆ·å">
        </div>

        <div style="text-align: center;">
            <button id="btnReg" class="btn btn-success">ğŸ“ æ³¨å†Œ Passkey</button>
            <button id="btnLogin" class="btn">ğŸ”‘ ç™»å½•</button>
            <button id="btnTestToken" class="btn" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">ğŸ§ª æµ‹è¯• Token</button>
        </div>

        <div id="status"></div>
        <pre id="log"></pre>
    </div>

    <script>
        const API = 'http://localhost:3001'; // åç«¯ API åœ°å€
        
        // å·¥å…·å‡½æ•°
        function log(...args) { 
            const el = document.getElementById('log'); 
            el.textContent += args.join(' ') + '\n'; 
        }
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function bufToBase64url(buf) {
            return btoa(String.fromCharCode(...new Uint8Array(buf)))
                .replaceAll('+','-').replaceAll('/','_').replaceAll('=','');
        }
        
        function base64urlToBuf(b64url) {
            const pad = '='.repeat((4 - b64url.length % 4) % 4);
            const b64 = (b64url + pad).replaceAll('-','+').replaceAll('_','/');
            const raw = atob(b64);
            const arr = new Uint8Array(raw.length);
            for (let i=0;i<raw.length;i++) arr[i] = raw.charCodeAt(i);
            return arr.buffer;
        }

        // æ£€æŸ¥ WebAuthn æ”¯æŒ
        function checkWebAuthnSupport() {
            if (!window.PublicKeyCredential) {
                showStatus('âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ WebAuthn/Passkey åŠŸèƒ½', 'error');
                return false;
            }
            if (!navigator.credentials) {
                showStatus('âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Credentials API', 'error');
                return false;
            }
            showStatus('âœ… æµè§ˆå™¨æ”¯æŒ WebAuthn/Passkey', 'success');
            return true;
        }

        // æ³¨å†Œ Passkey
        document.getElementById('btnReg').onclick = async () => {
            if (!checkWebAuthnSupport()) return;
            
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showStatus('âŒ è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            showStatus('ğŸ”„ å¼€å§‹æ³¨å†Œ Passkey...', 'info');
            log('å¼€å§‹æ³¨å†Œ', username);
            
            try {
                // 1. è·å–æ³¨å†Œé€‰é¡¹
                const resp = await fetch(API + '/webauthn/registration/options', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, displayName: username }),
                });
                
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
                }
                
                const opts = await resp.json();
                log('æ”¶åˆ°æ³¨å†Œé€‰é¡¹');
                
                // 2. è½¬æ¢å­—æ®µæ ¼å¼
                opts.challenge = base64urlToBuf(opts.challenge);
                opts.user.id = new TextEncoder().encode(opts.user.id);
                if (opts.excludeCredentials) {
                    opts.excludeCredentials = opts.excludeCredentials.map(c => ({
                        ...c, id: base64urlToBuf(c.id)
                    }));
                }
                
                // 3. è°ƒç”¨ WebAuthn API åˆ›å»ºå‡­è¯
                log('è°ƒç”¨ WebAuthn API åˆ›å»ºå‡­è¯...');
                const attResp = await navigator.credentials.create({ publicKey: opts });
                if (!attResp) {
                    showStatus('âŒ ç”¨æˆ·å–æ¶ˆæ³¨å†Œ', 'error');
                    return;
                }
                
                // 4. è½¬æ¢å“åº”æ ¼å¼
                const clientDataJSON = bufToBase64url(attResp.response.clientDataJSON);
                const attestationObject = bufToBase64url(attResp.response.attestationObject);
                const data = {
                    id: attResp.id,
                    rawId: bufToBase64url(attResp.rawId),
                    type: attResp.type,
                    response: { clientDataJSON, attestationObject },
                };
                
                // 5. æäº¤åˆ°åç«¯éªŒè¯
                log('æäº¤å‡­è¯åˆ°åç«¯éªŒè¯...');
                const v = await fetch(API + '/webauthn/registration/verify', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, attResp: data }),
                }).then(r => r.json());
                
                log('æ³¨å†Œç»“æœ:', JSON.stringify(v, null, 2));
                
                if (v.verified) {
                    showStatus('âœ… Passkey æ³¨å†ŒæˆåŠŸï¼', 'success');
                } else {
                    showStatus('âŒ æ³¨å†Œå¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showStatus(`âŒ æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
                log('æ³¨å†Œé”™è¯¯:', error.message);
            }
        };

        // ç™»å½•
        document.getElementById('btnLogin').onclick = async () => {
            if (!checkWebAuthnSupport()) return;
            
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showStatus('âŒ è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            showStatus('ğŸ”„ å¼€å§‹ç™»å½•...', 'info');
            log('å¼€å§‹ç™»å½•', username);
            
            try {
                // 1. è·å–è®¤è¯é€‰é¡¹
                const resp = await fetch(API + '/webauthn/authentication/options', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username }),
                });
                
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
                }
                
                const opts = await resp.json();
                log('æ”¶åˆ°è®¤è¯é€‰é¡¹');
                
                // 2. è½¬æ¢å­—æ®µæ ¼å¼
                opts.challenge = base64urlToBuf(opts.challenge);
                if (opts.allowCredentials) {
                    opts.allowCredentials = opts.allowCredentials.map(c => ({
                        ...c, id: base64urlToBuf(c.id)
                    }));
                }
                
                // 3. è°ƒç”¨ WebAuthn API è·å–è®¤è¯
                log('è°ƒç”¨ WebAuthn API è¿›è¡Œè®¤è¯...');
                const authResp = await navigator.credentials.get({ publicKey: opts });
                if (!authResp) {
                    showStatus('âŒ ç”¨æˆ·å–æ¶ˆç™»å½•', 'error');
                    return;
                }
                
                // 4. è½¬æ¢å“åº”æ ¼å¼
                const data = {
                    id: authResp.id,
                    rawId: bufToBase64url(authResp.rawId),
                    type: authResp.type,
                    response: {
                        clientDataJSON: bufToBase64url(authResp.response.clientDataJSON),
                        authenticatorData: bufToBase64url(authResp.response.authenticatorData),
                        signature: bufToBase64url(authResp.response.signature),
                        userHandle: authResp.response.userHandle ? bufToBase64url(authResp.response.userHandle) : null,
                    }
                };
                
                // 5. æäº¤åˆ°åç«¯éªŒè¯
                log('æäº¤è®¤è¯å“åº”åˆ°åç«¯éªŒè¯...');
                const v = await fetch(API + '/webauthn/authentication/verify', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, authResp: data }),
                }).then(r => r.json());
                
                log('ç™»å½•éªŒè¯ç»“æœ:', JSON.stringify(v, null, 2));
                
                if (v.verified && v.code) {
                    showStatus('âœ… ç™»å½•æˆåŠŸï¼è·å¾—æˆæƒç ', 'success');
                    log('è·å¾—æˆæƒç :', v.code);
                    
                    // 6. ç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ
                    log('ç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ...');
                    const tokenResp = await fetch(API + '/oauth/token', {
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ code: v.code })
                    });
                    
                    if (tokenResp.ok) {
                        const tokenData = await tokenResp.json();
                        log('è·å¾—è®¿é—®ä»¤ç‰Œ:', JSON.stringify(tokenData, null, 2));
                        showStatus('ğŸ‰ å®Œæ•´ç™»å½•æµç¨‹æˆåŠŸï¼å·²è·å¾—è®¿é—®ä»¤ç‰Œ', 'success');
                        
                        // ä¿å­˜ä»¤ç‰Œåˆ°æœ¬åœ°å­˜å‚¨ï¼ˆæ¼”ç¤ºç”¨ï¼‰
                        localStorage.setItem('access_token', tokenData.access_token);
                        localStorage.setItem('token_type', tokenData.token_type);
                        localStorage.setItem('expires_in', tokenData.expires_in);
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ä» iOS åº”ç”¨è·³è½¬è¿‡æ¥çš„ï¼Œå¦‚æœæ˜¯åˆ™é‡å®šå‘å›åº”ç”¨
                        const urlParams = new URLSearchParams(window.location.search);
                        const state = urlParams.get('state');
                        if (state) {
                            log('æ£€æµ‹åˆ° iOS åº”ç”¨è·³è½¬ï¼Œå‡†å¤‡é‡å®šå‘...');
                            // å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                            setTimeout(() => {
                                const callbackUrl = `passkeydemo://auth?code=${v.code}&state=${state}`;
                                log('é‡å®šå‘åˆ°:', callbackUrl);
                                window.location.href = callbackUrl;
                            }, 2000);
                        }
                        
                    } else {
                        const errorText = await tokenResp.text();
                        showStatus(`âŒ ä»¤ç‰Œäº¤æ¢å¤±è´¥: ${errorText}`, 'error');
                        log('ä»¤ç‰Œäº¤æ¢å¤±è´¥:', errorText);
                    }
                } else {
                    showStatus('âŒ ç™»å½•éªŒè¯å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showStatus(`âŒ ç™»å½•å¤±è´¥: ${error.message}`, 'error');
                log('ç™»å½•é”™è¯¯:', error.message);
            }
        };

        // æµ‹è¯• Token
        document.getElementById('btnTestToken').onclick = async () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                showStatus('âŒ æ²¡æœ‰æ‰¾åˆ°è®¿é—®ä»¤ç‰Œï¼Œè¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            showStatus('ğŸ”„ æµ‹è¯•è®¿é—®ä»¤ç‰Œ...', 'info');
            log('æµ‹è¯•è®¿é—®ä»¤ç‰Œ:', token.substring(0, 20) + '...');
            
            try {
                const resp = await fetch(API + '/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (resp.ok) {
                    const userData = await resp.json();
                    log('ç”¨æˆ·ä¿¡æ¯:', JSON.stringify(userData, null, 2));
                    showStatus('âœ… ä»¤ç‰Œæœ‰æ•ˆï¼Œè·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸï¼', 'success');
                } else {
                    const errorText = await resp.text();
                    showStatus(`âŒ ä»¤ç‰Œæ— æ•ˆ: ${errorText}`, 'error');
                    log('ä»¤ç‰ŒéªŒè¯å¤±è´¥:', errorText);
                }
            } catch (error) {
                console.error('ä»¤ç‰Œæµ‹è¯•é”™è¯¯:', error);
                showStatus(`âŒ ä»¤ç‰Œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                log('ä»¤ç‰Œæµ‹è¯•é”™è¯¯:', error.message);
            }
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ”¯æŒæƒ…å†µ
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            checkWebAuthnSupport();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„ä»¤ç‰Œ
            const token = localStorage.getItem('access_token');
            if (token) {
                showStatus('â„¹ï¸ æ£€æµ‹åˆ°å·²ä¿å­˜çš„è®¿é—®ä»¤ç‰Œ', 'info');
                log('å·²ä¿å­˜çš„ä»¤ç‰Œ:', token.substring(0, 20) + '...');
            }
            
            // æ£€æŸ¥ URL å‚æ•°ï¼Œçœ‹æ˜¯å¦æ˜¯ä» iOS åº”ç”¨è·³è½¬è¿‡æ¥çš„
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');
            const state = urlParams.get('state');
            
            if (username) {
                document.getElementById('username').value = username;
                log('ä» iOS åº”ç”¨è·³è½¬ï¼Œç”¨æˆ·å:', username);
                if (state) {
                    log('State å‚æ•°:', state);
                }
            }
        });
    </script>
</body>
</html>
