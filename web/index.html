<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passkey Demo - 无密码登录演示</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 600;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .demo-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        .demo-info h3 {
            margin-top: 0;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 Passkey Demo</h1>
        
        <div class="demo-info">
            <h3>📱 演示说明</h3>
            <p>这是一个 Passkey 无密码登录演示系统。支持在 iOS Safari 中使用 Face ID/Touch ID 进行安全登录。</p>
            <p><strong>注意：</strong>请在 iOS Safari 或支持 WebAuthn 的现代浏览器中打开此页面。</p>
        </div>

        <div class="form-group">
            <label for="username">用户名：</label>
            <input type="text" id="username" value="demo_user" placeholder="输入用户名">
        </div>

        <div style="text-align: center;">
            <button id="btnReg" class="btn btn-success">📝 注册 Passkey</button>
            <button id="btnLogin" class="btn">🔑 登录</button>
            <button id="btnTestToken" class="btn" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">🧪 测试 Token</button>
        </div>

        <div id="status"></div>
        <pre id="log"></pre>
    </div>

    <script>
        const API = 'http://localhost:3001'; // 后端 API 地址
        
        // 工具函数
        function log(...args) { 
            const el = document.getElementById('log'); 
            el.textContent += args.join(' ') + '\n'; 
        }
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function bufToBase64url(buf) {
            return btoa(String.fromCharCode(...new Uint8Array(buf)))
                .replaceAll('+','-').replaceAll('/','_').replaceAll('=','');
        }
        
        function base64urlToBuf(b64url) {
            const pad = '='.repeat((4 - b64url.length % 4) % 4);
            const b64 = (b64url + pad).replaceAll('-','+').replaceAll('_','/');
            const raw = atob(b64);
            const arr = new Uint8Array(raw.length);
            for (let i=0;i<raw.length;i++) arr[i] = raw.charCodeAt(i);
            return arr.buffer;
        }

        // 检查 WebAuthn 支持
        function checkWebAuthnSupport() {
            if (!window.PublicKeyCredential) {
                showStatus('❌ 当前浏览器不支持 WebAuthn/Passkey 功能', 'error');
                return false;
            }
            if (!navigator.credentials) {
                showStatus('❌ 当前浏览器不支持 Credentials API', 'error');
                return false;
            }
            showStatus('✅ 浏览器支持 WebAuthn/Passkey', 'success');
            return true;
        }

        // 注册 Passkey
        document.getElementById('btnReg').onclick = async () => {
            if (!checkWebAuthnSupport()) return;
            
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showStatus('❌ 请输入用户名', 'error');
                return;
            }
            
            showStatus('🔄 开始注册 Passkey...', 'info');
            log('开始注册', username);
            
            try {
                // 1. 获取注册选项
                const resp = await fetch(API + '/webauthn/registration/options', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, displayName: username }),
                });
                
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
                }
                
                const opts = await resp.json();
                log('收到注册选项');
                
                // 2. 转换字段格式
                opts.challenge = base64urlToBuf(opts.challenge);
                opts.user.id = new TextEncoder().encode(opts.user.id);
                if (opts.excludeCredentials) {
                    opts.excludeCredentials = opts.excludeCredentials.map(c => ({
                        ...c, id: base64urlToBuf(c.id)
                    }));
                }
                
                // 3. 调用 WebAuthn API 创建凭证
                log('调用 WebAuthn API 创建凭证...');
                const attResp = await navigator.credentials.create({ publicKey: opts });
                if (!attResp) {
                    showStatus('❌ 用户取消注册', 'error');
                    return;
                }
                
                // 4. 转换响应格式
                const clientDataJSON = bufToBase64url(attResp.response.clientDataJSON);
                const attestationObject = bufToBase64url(attResp.response.attestationObject);
                const data = {
                    id: attResp.id,
                    rawId: bufToBase64url(attResp.rawId),
                    type: attResp.type,
                    response: { clientDataJSON, attestationObject },
                };
                
                // 5. 提交到后端验证
                log('提交凭证到后端验证...');
                const v = await fetch(API + '/webauthn/registration/verify', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, attResp: data }),
                }).then(r => r.json());
                
                log('注册结果:', JSON.stringify(v, null, 2));
                
                if (v.verified) {
                    showStatus('✅ Passkey 注册成功！', 'success');
                } else {
                    showStatus('❌ 注册失败', 'error');
                }
                
            } catch (error) {
                console.error('注册错误:', error);
                showStatus(`❌ 注册失败: ${error.message}`, 'error');
                log('注册错误:', error.message);
            }
        };

        // 登录
        document.getElementById('btnLogin').onclick = async () => {
            if (!checkWebAuthnSupport()) return;
            
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showStatus('❌ 请输入用户名', 'error');
                return;
            }
            
            showStatus('🔄 开始登录...', 'info');
            log('开始登录', username);
            
            try {
                // 1. 获取认证选项
                const resp = await fetch(API + '/webauthn/authentication/options', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username }),
                });
                
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
                }
                
                const opts = await resp.json();
                log('收到认证选项');
                
                // 2. 转换字段格式
                opts.challenge = base64urlToBuf(opts.challenge);
                if (opts.allowCredentials) {
                    opts.allowCredentials = opts.allowCredentials.map(c => ({
                        ...c, id: base64urlToBuf(c.id)
                    }));
                }
                
                // 3. 调用 WebAuthn API 获取认证
                log('调用 WebAuthn API 进行认证...');
                const authResp = await navigator.credentials.get({ publicKey: opts });
                if (!authResp) {
                    showStatus('❌ 用户取消登录', 'error');
                    return;
                }
                
                // 4. 转换响应格式
                const data = {
                    id: authResp.id,
                    rawId: bufToBase64url(authResp.rawId),
                    type: authResp.type,
                    response: {
                        clientDataJSON: bufToBase64url(authResp.response.clientDataJSON),
                        authenticatorData: bufToBase64url(authResp.response.authenticatorData),
                        signature: bufToBase64url(authResp.response.signature),
                        userHandle: authResp.response.userHandle ? bufToBase64url(authResp.response.userHandle) : null,
                    }
                };
                
                // 5. 提交到后端验证
                log('提交认证响应到后端验证...');
                const v = await fetch(API + '/webauthn/authentication/verify', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, authResp: data }),
                }).then(r => r.json());
                
                log('登录验证结果:', JSON.stringify(v, null, 2));
                
                if (v.verified && v.code) {
                    showStatus('✅ 登录成功！获得授权码', 'success');
                    log('获得授权码:', v.code);
                    
                    // 6. 用授权码换取访问令牌
                    log('用授权码换取访问令牌...');
                    const tokenResp = await fetch(API + '/oauth/token', {
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ code: v.code })
                    });
                    
                    if (tokenResp.ok) {
                        const tokenData = await tokenResp.json();
                        log('获得访问令牌:', JSON.stringify(tokenData, null, 2));
                        showStatus('🎉 完整登录流程成功！已获得访问令牌', 'success');
                        
                        // 保存令牌到本地存储（演示用）
                        localStorage.setItem('access_token', tokenData.access_token);
                        localStorage.setItem('token_type', tokenData.token_type);
                        localStorage.setItem('expires_in', tokenData.expires_in);
                        
                        // 检查是否是从 iOS 应用跳转过来的，如果是则重定向回应用
                        const urlParams = new URLSearchParams(window.location.search);
                        const state = urlParams.get('state');
                        if (state) {
                            log('检测到 iOS 应用跳转，准备重定向...');
                            // 延迟一下让用户看到成功消息
                            setTimeout(() => {
                                const callbackUrl = `passkeydemo://auth?code=${v.code}&state=${state}`;
                                log('重定向到:', callbackUrl);
                                window.location.href = callbackUrl;
                            }, 2000);
                        }
                        
                    } else {
                        const errorText = await tokenResp.text();
                        showStatus(`❌ 令牌交换失败: ${errorText}`, 'error');
                        log('令牌交换失败:', errorText);
                    }
                } else {
                    showStatus('❌ 登录验证失败', 'error');
                }
                
            } catch (error) {
                console.error('登录错误:', error);
                showStatus(`❌ 登录失败: ${error.message}`, 'error');
                log('登录错误:', error.message);
            }
        };

        // 测试 Token
        document.getElementById('btnTestToken').onclick = async () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                showStatus('❌ 没有找到访问令牌，请先登录', 'error');
                return;
            }
            
            showStatus('🔄 测试访问令牌...', 'info');
            log('测试访问令牌:', token.substring(0, 20) + '...');
            
            try {
                const resp = await fetch(API + '/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (resp.ok) {
                    const userData = await resp.json();
                    log('用户信息:', JSON.stringify(userData, null, 2));
                    showStatus('✅ 令牌有效，获取用户信息成功！', 'success');
                } else {
                    const errorText = await resp.text();
                    showStatus(`❌ 令牌无效: ${errorText}`, 'error');
                    log('令牌验证失败:', errorText);
                }
            } catch (error) {
                console.error('令牌测试错误:', error);
                showStatus(`❌ 令牌测试失败: ${error.message}`, 'error');
                log('令牌测试错误:', error.message);
            }
        };

        // 页面加载时检查支持情况
        window.addEventListener('load', () => {
            log('页面加载完成');
            checkWebAuthnSupport();
            
            // 检查是否有已保存的令牌
            const token = localStorage.getItem('access_token');
            if (token) {
                showStatus('ℹ️ 检测到已保存的访问令牌', 'info');
                log('已保存的令牌:', token.substring(0, 20) + '...');
            }
            
            // 检查 URL 参数，看是否是从 iOS 应用跳转过来的
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');
            const state = urlParams.get('state');
            
            if (username) {
                document.getElementById('username').value = username;
                log('从 iOS 应用跳转，用户名:', username);
                if (state) {
                    log('State 参数:', state);
                }
            }
        });
    </script>
</body>
</html>
