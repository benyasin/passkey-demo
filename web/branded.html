<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨è®¤è¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .auth-card {
            background: white;
            border-radius: 24px;
            padding: 60px 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 400px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }
        
        .title {
            font-size: 28px;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 12px;
        }
        
        .subtitle {
            font-size: 16px;
            color: #86868b;
            margin-bottom: 40px;
            line-height: 1.5;
        }
        
        .security-badge {
            display: inline-flex;
            align-items: center;
            background: #f0f9ff;
            color: #0369a1;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 32px;
        }
        
        .security-badge::before {
            content: 'ğŸ”’';
            margin-right: 8px;
        }
        
        .biometric-prompt {
            background: #f8f9fa;
            border: 2px dashed #e9ecef;
            border-radius: 16px;
            padding: 32px 24px;
            margin-bottom: 32px;
        }
        
        .biometric-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #34c759, #30d158);
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .biometric-text {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 8px;
        }
        
        .biometric-subtitle {
            font-size: 14px;
            color: #86868b;
        }
        
        .status {
            font-size: 14px;
            color: #86868b;
            margin-top: 20px;
        }
        
        .success {
            color: #34c759;
        }
        
        .error {
            color: #ff3b30;
        }
        
        .loading {
            color: #007AFF;
        }
        
        .footer {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #86868b;
        }
    </style>
</head>
<body>
    <div class="auth-card">
        <div class="logo">ğŸ”</div>
        <div class="title">å®‰å…¨è®¤è¯</div>
        <div class="subtitle">ä¸ºäº†æ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œè¯·å®Œæˆèº«ä»½éªŒè¯</div>
        
        <div class="security-badge">é“¶è¡Œçº§å®‰å…¨åŠ å¯†</div>
        
        <div class="biometric-prompt">
            <div class="biometric-icon" id="biometricIcon">ğŸ‘†</div>
            <div class="biometric-text" id="biometricText">è¯·ä½¿ç”¨ Face ID éªŒè¯èº«ä»½</div>
            <div class="biometric-subtitle" id="biometricSubtitle">å°†æ‰‹æŒ‡æ”¾åœ¨ Touch ID ä¼ æ„Ÿå™¨ä¸Š</div>
        </div>
        
        <div class="status" id="status"></div>
        
        <div class="footer">
            <div>Powered by WebAuthn æŠ€æœ¯</div>
            <div>æ‚¨çš„ç”Ÿç‰©ä¿¡æ¯ä»…ç”¨äºæœ¬åœ°éªŒè¯ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3001';
        
        // å·¥å…·å‡½æ•°
        function updateStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = type;
        }
        
        function updateBiometricUI(icon, text, subtitle) {
            document.getElementById('biometricIcon').textContent = icon;
            document.getElementById('biometricText').textContent = text;
            document.getElementById('biometricSubtitle').textContent = subtitle;
        }
        
        function bufToBase64url(buf) {
            return btoa(String.fromCharCode(...new Uint8Array(buf)))
                .replaceAll('+','-').replaceAll('/','_').replaceAll('=','');
        }
        
        function base64urlToBuf(b64url) {
            const pad = '='.repeat((4 - b64url.length % 4) % 4);
            const b64 = (b64url + pad).replaceAll('-','+').replaceAll('_','/');
            const raw = atob(b64);
            const arr = new Uint8Array(raw.length);
            for (let i=0;i<raw.length;i++) arr[i] = raw.charCodeAt(i);
            return arr.buffer;
        }

        // æ£€æŸ¥ WebAuthn æ”¯æŒ
        function checkWebAuthnSupport() {
            if (!window.PublicKeyCredential) {
                updateBiometricUI('âŒ', 'ä¸æ”¯æŒç”Ÿç‰©è¯†åˆ«', 'å½“å‰è®¾å¤‡ä¸æ”¯æŒ WebAuthn åŠŸèƒ½');
                updateStatus('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ WebAuthn/Passkey åŠŸèƒ½', 'error');
                return false;
            }
            if (!navigator.credentials) {
                updateBiometricUI('âŒ', 'ä¸æ”¯æŒç”Ÿç‰©è¯†åˆ«', 'å½“å‰è®¾å¤‡ä¸æ”¯æŒ Credentials API');
                updateStatus('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Credentials API', 'error');
                return false;
            }
            return true;
        }

        // æ‰§è¡Œæ³¨å†Œæµç¨‹
        async function performRegistration(username) {
            if (!checkWebAuthnSupport()) return;
            
            updateBiometricUI('ğŸ”', 'æ­£åœ¨å‡†å¤‡æ³¨å†Œ', 'è¯·ç¨å€™...');
            updateStatus('æ­£åœ¨å‡†å¤‡æ³¨å†Œ Passkey...', 'loading');
            
            try {
                // 1. è·å–æ³¨å†Œé€‰é¡¹
                updateBiometricUI('â³', 'æ­£åœ¨è·å–æ³¨å†Œé€‰é¡¹', 'è¿æ¥æœåŠ¡å™¨ä¸­...');
                const resp = await fetch(API + '/webauthn/registration/options', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, displayName: username }),
                });
                
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
                }
                
                const opts = await resp.json();
                
                // 2. è½¬æ¢å­—æ®µæ ¼å¼
                opts.challenge = base64urlToBuf(opts.challenge);
                opts.user.id = new TextEncoder().encode(opts.user.id);
                if (opts.excludeCredentials) {
                    opts.excludeCredentials = opts.excludeCredentials.map(c => ({
                        ...c, id: base64urlToBuf(c.id)
                    }));
                }
                
                // 3. è°ƒç”¨ WebAuthn API åˆ›å»ºå‡­è¯
                updateBiometricUI('ğŸ”', 'è¯·ä½¿ç”¨ Face ID æˆ– Touch ID', 'æ­£åœ¨éªŒè¯èº«ä»½...');
                updateStatus('è¯·ä½¿ç”¨ç”Ÿç‰©è¯†åˆ«å®Œæˆæ³¨å†Œ...', 'loading');
                
                // æ·»åŠ å»¶è¿Ÿç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                console.log('å‡†å¤‡è°ƒç”¨ WebAuthn API åˆ›å»ºå‡­è¯ï¼Œé€‰é¡¹:', opts);
                
                // ç›´æ¥è°ƒç”¨ WebAuthn API
                const attResp = await navigator.credentials.create({ 
                    publicKey: {
                        ...opts,
                        timeout: 60000 // 60ç§’è¶…æ—¶
                    }
                });
                
                console.log('WebAuthn API å“åº”:', attResp);
                if (!attResp) {
                    updateBiometricUI('âŒ', 'ç”¨æˆ·å–æ¶ˆæ³¨å†Œ', 'è¯·é‡è¯•æˆ–è¿”å›åº”ç”¨');
                    updateStatus('ç”¨æˆ·å–æ¶ˆæ³¨å†Œ', 'error');
                    return;
                }
                
                // 4. è½¬æ¢å“åº”æ ¼å¼
                updateBiometricUI('â³', 'æ­£åœ¨éªŒè¯æ³¨å†Œä¿¡æ¯', 'è¯·ç¨å€™...');
                const clientDataJSON = bufToBase64url(attResp.response.clientDataJSON);
                const attestationObject = bufToBase64url(attResp.response.attestationObject);
                const data = {
                    id: attResp.id,
                    rawId: bufToBase64url(attResp.rawId),
                    type: attResp.type,
                    response: { clientDataJSON, attestationObject },
                };
                
                // 5. æäº¤åˆ°åç«¯éªŒè¯
                const v = await fetch(API + '/webauthn/registration/verify', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, attResp: data }),
                }).then(r => r.json());
                
                if (v.verified) {
                    updateBiometricUI('âœ…', 'æ³¨å†ŒæˆåŠŸ', 'Passkey å·²ä¿å­˜åˆ°è®¾å¤‡');
                    updateStatus('Passkey æ³¨å†ŒæˆåŠŸï¼', 'success');
                    
                    setTimeout(() => {
                        const urlParams = new URLSearchParams(window.location.search);
                        const state = urlParams.get('state');
                        if (state) {
                            window.location.href = `passkeydemo://auth?success=true&state=${state}`;
                        }
                    }, 2000);
                } else {
                    updateBiometricUI('âŒ', 'æ³¨å†ŒéªŒè¯å¤±è´¥', 'è¯·é‡è¯•');
                    updateStatus('æ³¨å†ŒéªŒè¯å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                updateBiometricUI('âŒ', 'æ³¨å†Œå¤±è´¥', error.message);
                updateStatus(`æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‰§è¡Œç™»å½•æµç¨‹
        async function performLogin(username) {
            if (!checkWebAuthnSupport()) return;
            
            updateBiometricUI('ğŸ”', 'æ­£åœ¨å‡†å¤‡ç™»å½•', 'è¯·ç¨å€™...');
            updateStatus('æ­£åœ¨å‡†å¤‡ç™»å½•...', 'loading');
            
            try {
                // 1. è·å–è®¤è¯é€‰é¡¹
                updateBiometricUI('â³', 'æ­£åœ¨è·å–è®¤è¯é€‰é¡¹', 'è¿æ¥æœåŠ¡å™¨ä¸­...');
                const resp = await fetch(API + '/webauthn/authentication/options', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username }),
                });
                
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
                }
                
                const opts = await resp.json();
                
                // 2. è½¬æ¢å­—æ®µæ ¼å¼
                opts.challenge = base64urlToBuf(opts.challenge);
                if (opts.allowCredentials) {
                    opts.allowCredentials = opts.allowCredentials.map(c => ({
                        ...c, id: base64urlToBuf(c.id)
                    }));
                }
                
                // 3. è°ƒç”¨ WebAuthn API è·å–è®¤è¯
                updateBiometricUI('ğŸ”', 'è¯·ä½¿ç”¨ Face ID æˆ– Touch ID', 'æ­£åœ¨éªŒè¯èº«ä»½...');
                updateStatus('è¯·ä½¿ç”¨ç”Ÿç‰©è¯†åˆ«å®Œæˆç™»å½•...', 'loading');
                
                // æ·»åŠ å»¶è¿Ÿç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                console.log('å‡†å¤‡è°ƒç”¨ WebAuthn APIï¼Œé€‰é¡¹:', opts);
                
                // ç›´æ¥è°ƒç”¨ WebAuthn API
                const authResp = await navigator.credentials.get({ 
                    publicKey: {
                        ...opts,
                        timeout: 60000 // 60ç§’è¶…æ—¶
                    }
                });
                
                console.log('WebAuthn API å“åº”:', authResp);
                if (!authResp) {
                    updateBiometricUI('âŒ', 'ç”¨æˆ·å–æ¶ˆç™»å½•', 'è¯·é‡è¯•æˆ–è¿”å›åº”ç”¨');
                    updateStatus('ç”¨æˆ·å–æ¶ˆç™»å½•', 'error');
                    return;
                }
                
                // 4. è½¬æ¢å“åº”æ ¼å¼
                updateBiometricUI('â³', 'æ­£åœ¨éªŒè¯ç™»å½•ä¿¡æ¯', 'è¯·ç¨å€™...');
                const data = {
                    id: authResp.id,
                    rawId: bufToBase64url(authResp.rawId),
                    type: authResp.type,
                    response: {
                        clientDataJSON: bufToBase64url(authResp.response.clientDataJSON),
                        authenticatorData: bufToBase64url(authResp.response.authenticatorData),
                        signature: bufToBase64url(authResp.response.signature),
                        userHandle: authResp.response.userHandle ? bufToBase64url(authResp.response.userHandle) : null,
                    }
                };
                
                // 5. æäº¤åˆ°åç«¯éªŒè¯
                const v = await fetch(API + '/webauthn/authentication/verify', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, authResp: data }),
                }).then(r => r.json());
                
                if (v.verified && v.code) {
                    updateBiometricUI('âœ…', 'ç™»å½•æˆåŠŸ', 'æ­£åœ¨è¿”å›åº”ç”¨...');
                    updateStatus('ç™»å½•æˆåŠŸï¼è·å¾—æˆæƒç ', 'success');
                    
                    setTimeout(() => {
                        const urlParams = new URLSearchParams(window.location.search);
                        const state = urlParams.get('state');
                        if (state) {
                            window.location.href = `passkeydemo://auth?code=${v.code}&state=${state}`;
                        }
                    }, 2000);
                } else {
                    updateBiometricUI('âŒ', 'ç™»å½•éªŒè¯å¤±è´¥', 'è¯·é‡è¯•');
                    updateStatus('ç™»å½•éªŒè¯å¤±è´¥', 'error');
                }
                
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                updateBiometricUI('âŒ', 'ç™»å½•å¤±è´¥', error.message);
                updateStatus(`ç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œè®¤è¯æµç¨‹
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');
            const action = urlParams.get('action');
            
            if (!username) {
                updateBiometricUI('âŒ', 'ç¼ºå°‘ç”¨æˆ·åå‚æ•°', 'è¯·ä»åº”ç”¨é‡æ–°å¼€å§‹');
                updateStatus('ç¼ºå°‘ç”¨æˆ·åå‚æ•°', 'error');
                return;
            }
            
            if (!action) {
                updateBiometricUI('âŒ', 'ç¼ºå°‘æ“ä½œç±»å‹å‚æ•°', 'è¯·ä»åº”ç”¨é‡æ–°å¼€å§‹');
                updateStatus('ç¼ºå°‘æ“ä½œç±»å‹å‚æ•°', 'error');
                return;
            }
            
            // æ ¹æ®æ“ä½œç±»å‹æ‰§è¡Œç›¸åº”æµç¨‹
            if (action === 'register') {
                performRegistration(username);
            } else if (action === 'login') {
                performLogin(username);
            } else {
                updateBiometricUI('âŒ', 'æ— æ•ˆçš„æ“ä½œç±»å‹', 'è¯·ä»åº”ç”¨é‡æ–°å¼€å§‹');
                updateStatus('æ— æ•ˆçš„æ“ä½œç±»å‹', 'error');
            }
        });
    </script>
</body>
</html>
